<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script>

	

		
	function loadCollection(collection, shiftBy){
		var svg = d3.select("body").append("svg")
				.attr("width", 1000)
				.attr("height", 1000)
				.append("g")
					.attr("transform", "translate(" + shiftBy + "," + shiftBy + ")");

		var json;

		d3.json(collection, function(error, root) {
			if (error) console.log("error");

			var focus = root;
			

		/*var pack = d3.layout.pack()
		.padding(2)
		.size([700,700])
		.value(function(d){
			if (d[0].hasOwnProperty("http://purl.org/ASN/schema/core/statementLabel")){
				switch(d[0]["http://purl.org/ASN/schema/core/statementLabel"][0]["value"]){
					case "Standard":
						return 5*Math.random()*1000;
					case "Cluster":
						return 5*Math.random()*10000;
					case "Domain" :
						return 5*Math.random()*100000;
					case "Component":
						return 5*Math.random()*1000000;
				}
			}
		});*/

		svg.append("circle")
			.attr("r", "30px")
			.attr("stroke", "green")
			.attr("stroke-width", "1.5px")
			.attr("fill", "#fff")
			.on("click", function(d) {displayDomains()});

					

		/*var genInfo = root["http://asn.jesandco.org/resources/D10003FB"];
		delete root["http://asn.jesandco.org/resources/D10003FB"];
		delete root["http://asn.jesandco.org/resources/D10003FB.xml"];*/

		var Domains = [];
		for (x in root) {
			/*
			if (root[x].hasOwnProperty("http://purl.org/dc/terms/description")){
				root[x]["name"] = root[x]["http://purl.org/dc/terms/description"][0]["value"];
			}
			root[x]["children"] = [];
			if (root[x].hasOwnProperty("http://purl.org/gem/qualifiers/hasChild")){
				for (i in root[x]["http://purl.org/gem/qualifiers/hasChild"]){
					root[x]["children"].push(root[x]["http://purl.org/gem/qualifiers/hasChild"][i]["value"]);
				}
			}*/
			
			if (root[x].hasOwnProperty("http://purl.org/ASN/schema/core/statementLabel") && root[x]["http://purl.org/ASN/schema/core/statementLabel"][0]["value"]=="Domain"){
					Domains.push(x);
			}
		}

		/*for (x in root){
			temp = [];
			temp.push(root[x]);
			nodeArray.push(pack.nodes(temp));
		}*/
		
		console.log(Domains);

		var nodeDistance = 180/(Domains.length);
		var endAngle = 0;
		var beginAngle = 0;


		var layerAngles = [0,0,0,0]
		var colorNodes = ["blue","red","green","black"]
		function displayDomains(){
			var node = svg.selectAll("g")
					.data(Domains)					
					.enter();

			var backgrounds = node.append("g");


			

			svg.select("circle")
				.on("click", function(d){returnPositions()});

			var circles = backgrounds.append("circle")
				.on("click", function(d,i) {
					svg.selectAll("path").remove();
					shiftCircles(d,i,nodeDistance*2*i);
					displayInner(d,3,nodeDistance*2*i);
				});

			function returnPositions() {
				backgrounds.transition().duration(1000).attr("transform", function(d,i) {
							return "rotate("+ nodeDistance*2*i + ")translate(90)";
						})
						.attr("Level", 2);
				circles.transition().duration(1500).attr("r", 5);
				svg.selectAll("g").filter(function(d){return this.getAttribute("Level") > 2})
					.remove();
				svg.selectAll("path").remove();
			
			}

			returnPositions();

			circles.append("title")
					.text(function(d){
						return root[d]["http://purl.org/dc/terms/description"][0]["value"];
					})

			circles
				.attr("fill", "#fff")
				.attr("r",0)
				.attr("Level", 1)
				.transition()
				.duration(1000)	
				.attr("r",4.5)
				.attr("stroke", "blue")
				.attr("stroke-width",0)	
				.attr("stroke-width", "1.5px")

			
			/*function addLines(d,i){
				var line = d3.svg.line()
				    .x(function(d) { return x(...); })
				    .y(function(d) { return y(...); })
				    .interpolate("linear");

				svg.append("path")
					.attr("class", "line")
					.attr("d", function(d){return line(data)})
					.style("stroke","#000");
			}*/


			function shiftCircles(d,i,baseRotate) {
				target = d3.transform("rotate(" + baseRotate + ")translate(120)").translate;
				targetOffset = d3.transform("rotate(" + baseRotate + ")translate(10)").translate;
				var newPath = svg.append("path")
					.attr("d", d3.svg.diagonal()
						.source( function(d,i){
							offset = d3.transform("rotate(" + baseRotate + ")translate(40)").translate;
							sourceObject = {"x" : offset[0], "y" : offset[1]};
							return sourceObject;
						}
						)
						.target(function(d,i){
							targetObject = {"x": target[0] - targetOffset[0], "y": target[1] - targetOffset[1]}
							return targetObject;
						}
						)
					)
					.attr("fill", "none")
					.attr("stroke", "purple")
					.attr("Level", 1);
				layerAngles[0] = {beginAngle : baseRotate + 90, endAngle : nodeDistance * (Domains.length -2) + baseRotate + 90};
				var filterCondition = d;
				var coeff = (i > Domains.length/4 && i < Domains.length*3/4 ? 1 : 0);
				var thisCircle = circles.filter(function(d){return (d===filterCondition)}).transition()
					.duration(1500)
					.attr("r", 5);
				var thisBackground = backgrounds.filter(function(d){return (d===filterCondition)})
					.attr("transform", function(d,i) {
						return "rotate(" + baseRotate + ")translate(120)";
					});
				var others = circles.filter(function(d){return !(d===filterCondition)}).transition()
					.duration(1500)
					.attr("r", 2.25);
				var otherNodes = backgrounds.filter(function(d){return !(d===filterCondition)}).transition()
					.duration(1500)
					.attr("transform", function(d,i){
						return "rotate(" + (nodeDistance*i +baseRotate + 90) + ")translate(90)";
					});
				
				
				}
			/*node.append("text")
				.attr("dy", ".31em")
				.attr("text-anchor", "start")
				.attr("transform", "translate(8)")
				.text(function(d,i){
					return root[d]["http://purl.org/dc/terms/description"][0]["value"];
				});*/
			}

		
		function displayInner(parent, coeff, baseRotate) {
			var children = [];

			for (x in root[parent]["http://purl.org/gem/qualifiers/hasChild"]){
				children.push(root[parent]["http://purl.org/gem/qualifiers/hasChild"][x]["value"]);
			}
			console.log(children)
			var node2 = svg.selectAll("Level" + coeff)
				.data(children)
				.enter()

			console.log(parent);
			var parentCircle = svg.selectAll("g").filter(function(d){return d===parent});
			console.log(parentCircle);
			
			
			var unnecessary = svg.selectAll("g").filter(function(d){return this.getAttribute("Level") > coeff-1})
				.remove();
			var unnecessary2 = svg.selectAll("path").filter(function(d){
				return coeff != 3 && this.getAttribute("Level") == (coeff-2)}).remove();
			


			var backgrounds = node2.append("g");

			backgrounds.transition().duration(1500)
					.attr("transform", function(d,i) {
						return "rotate(" + (baseRotate - (children.length/2 - 0.5 - i) *10) + ")translate(" + 90*(coeff-1) + ")";
					})
					.attr("Level", coeff);


			function paths() {
			console.log(parentCircle);
			origin = d3.transform(parentCircle.attr("transform")).translate;
			//origin = d3.transform("rotate(" + baseRotate + ")translate(" + (90*(coeff-2)) + ")").translate;
			originOffset = d3.transform("rotate(" + baseRotate + ")translate(10)").translate;
			console.log(origin);

			
			var paths = node2.append("path")
					/*.attr("d", function(d,i){
						translation = "rotate(" + (baseRotate - (children.length/2 - 0.5 - i) *10) + ")translate(" + 90*(coeff-1) + ")";
						destination = d3.transform(translation).translate;
						console.log(destination);
						var sourceObject = {"x" : 100, "y" : 200};
						var targetObject = {"x" : 300, "y" : 400};
						return "M" + (destination[0]) + " " + (destination[1]) + " L" + (source[0]) + " "+ (source[1])+ "Z";
						d3.svg.diagonal()
							.source(sourceObject)
							.target(targetObject);
					})*/
					
					.attr("d", d3.svg.diagonal()
									.target(function(d,i){
										offset = d3.transform("rotate(" + (baseRotate - (children.length/2 - 0.5 - i) *10) + ")translate(10)").translate;
										
										translation = "rotate(" + (baseRotate - (children.length/2 - 0.5 - i) *10) + ")translate(" + 90*(coeff-1) + ")";
										destination = d3.transform(translation).translate;
										sourceObject = {"x" : destination[0] - offset[0], "y": destination[1] - offset[1]};
										return sourceObject;
									})
									.source(function(d,i){
										return {"x" : origin[0] + originOffset[0], "y" : origin[1] + originOffset[1]};
									})
							)
					.attr("stroke", "purple")

					.attr("fill", "none")
					.attr("Level", coeff-1);

				paths
					.attr("stroke-dasharray", paths.node().getTotalLength() + " " + paths.node().getTotalLength())
					.attr("stroke-dashoffset", paths.node().getTotalLength())
					.transition()
					.duration(1500)
					.attr("stroke-dashoffset", 0);
					
					
			}
			setTimeout(function(){return paths()}, 500);



			console.log(paths);
			

			var circles = backgrounds.append("circle")
					.attr("fill", "#fff")
					.attr("stroke", "blue")
					.attr("__data__", function(d){return d})
					.on("click", function(d,i) {
							shiftCircles(d,i);
							displayInner(d, coeff + 1, baseRotate);
							drawPrevious(d,i);
						});

			circles.transition().duration(1000)
				.attr("r",5)
				.attr("stroke-width", "1.5px");

			circles.append("title")
					.text(function(d,i){
									console.log(d);
									return root[d]["http://purl.org/dc/terms/description"][0]["value"];
								});

			
			function drawPrevious(d,i){
				//origin = d3.transform(parentCircle.attr("transform")).translate;
				origin = d3.transform("rotate(" + baseRotate + ")translate(" + (90*(coeff-1) - 10) + ")").translate;
				originOffset = d3.transform("rotate(" + baseRotate + ")translate(10)").translate;
				var newPath = svg.append("path")
					.attr("d", d3.svg.diagonal()
						.source( function(d,i){
							offset = d3.transform(parentCircle.attr("transform")).translate;
							sourceObject = {"x" : offset[0] + originOffset[0] , "y" : offset[1] + originOffset[1] };
							return sourceObject;
						}
						)
						.target(function(d,i){
							targetObject = {"x": origin[0], "y": origin[1]}
							return targetObject;
						}
						)
					)
					.attr("fill", "none")
					.attr("stroke", "purple")
					.attr("Level", coeff-1);
			}
				
				


			function shiftCircles(d,i){
				beginAngle = layerAngles[coeff-3]["beginAngle"];
				endAngle = layerAngles[coeff-3]["endAngle"];
				console.log(beginAngle);
				console.log(endAngle);
				var thisIndex = i;
				layerAngles[coeff-2] = {};
				console.log("length");
				console.log(backgrounds[0].length);
				layerAngles[coeff-2].beginAngle = beginAngle+nodeDistance*(thisIndex-(backgrounds[0].length-1));
				layerAngles[coeff-2].endAngle = endAngle+nodeDistance*thisIndex;
				var filterCondition = d;
				
				console.log(filterCondition);
				var others = backgrounds.transition()
								.duration(400)
								.attr("transform", function(d,i){
									if (i > thisIndex){
										return "rotate(" + (beginAngle + nodeDistance*(thisIndex-i)) + ")translate(90)";
									}
									else if (i < thisIndex){
										return "rotate(" + (endAngle + nodeDistance*(thisIndex - i)) + ")translate(90)";
									}
									else{
										console.log(d);
										return "rotate(" + baseRotate + ")translate(" + (90*(coeff-1)) + ")";
									}
									
								});

				
										

				var thisCircle = circles.filter(function(d)	{return (d===filterCondition)})
									.transition()
									.duration(1000)
									.attr("r", 4.5)
									.attr("stroke", "blue")
									.attr("__data__", d);
				console.log(circles);
				var otherCircles = circles.filter(function(d){return !(d===filterCondition)})
									.attr("r", 2.25)
									.attr("stroke", colorNodes[coeff-2])
									.attr("__data__", function(d){return d});

				circles.on("click",function(d,i){
					svg.selectAll("path").filter(function(d,i){return this.getAttribute("Level") == coeff}).remove();
					shiftCircles(d,i);
					displayInner(d,coeff+1,baseRotate)});
					setTimeout(function(){drawPrevious(d,i)}, 400);
				}

						/*.on("mouseover", function(d,i) {

						})			*/	
			}
					/*if (root[d].hasOwnProperty("http://purl.org/ASN/schema/core/statementLabel")){
						switch(root[d]["http://purl.org/ASN/schema/core/statementLabel"][0]["value"]){
							case "Standard":
								return 5;
							case "Cluster":
								return 10;
							case "Domain" :
								return 20;
							case "Component":
								return 2;
						};
						return 10;*/
						
		});

	}
	loadCollection("s1.json",480);
	</script>
</body>
</html>